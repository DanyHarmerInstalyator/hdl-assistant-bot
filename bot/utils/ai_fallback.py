import os
import httpx
import logging
import asyncio
from typing import Optional

logger = logging.getLogger(__name__)

class StableAIService:
    def __init__(self):
        self.request_count = 0
        self.available_models = [
            "mistralai/mistral-7b-instruct",
            "huggingfaceh4/zephyr-7b-beta", 
            "alibaba/tongyi-deepresearch-30b-a3b:free",
            "google/gemma-7b-it"
        ]
        self.current_model_index = 0
        self.max_retries = 2
        self.timeout = 30.0
        self.api_key = os.getenv("OPENROUTER_API_KEY")

    def get_current_model(self) -> str:
        return self.available_models[self.current_model_index]

    def switch_to_next_model(self) -> str:
        self.current_model_index = (self.current_model_index + 1) % len(self.available_models)
        logger.info(f"üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –º–æ–¥–µ–ª—å: {self.get_current_model()}")
        return self.get_current_model()

    def _prepare_system_prompt(self) -> str:
        """–£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç"""
        return """–¢–´ –î–û–õ–ñ–ï–ù –û–¢–í–ï–ß–ê–¢–¨ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï! –ù–ò–ö–ê–ö–û–ì–û –ê–ù–ì–õ–ò–ô–°–ö–û–ì–û!

–¢—ã ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é —É–º–Ω–æ–≥–æ –¥–æ–º–∞. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –±—Ä–µ–Ω–¥—ã: HDL, Buspro, Matech, URRI, iOT Systems, Yeelight Pro, CoolAutomation, Easycool.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –î–∞–≤–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã (–º–∏–Ω–∏–º—É–º 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
3. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ - –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º
4. –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–æ–≤–æ—Ä–∏ "—è –Ω–µ –ø–æ–Ω–∏–º–∞—é" –∏–ª–∏ "—ç—Ç–æ –≤–Ω–µ –º–æ–µ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏"

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
- –û–±—ä—è—Å–Ω–∏ —á—Ç–æ —ç—Ç–æ –∑–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
- –û–ø–∏—à–∏ –µ–≥–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏  
- –ü—Ä–µ–¥–ª–æ–∂–∏ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è

–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:
"CoolPlug - —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞–º–∏ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É —É–º–Ω–æ–≥–æ –¥–æ–º–∞. –û–Ω–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—ã—á–Ω—ã–µ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã –≤ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø–æ Wi-Fi –∏ –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –î–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –∏–ª–∏ –Ω–∞–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ –Ω–∞—à–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π."

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ!"""

    def _validate_ai_response(self, answer: str) -> tuple[bool, str]:
        """–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞"""
        if not answer or not answer.strip():
            return False, "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç"
        
        answer = answer.strip()
        
        # –ë–æ–ª–µ–µ –º—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã
        if len(answer) < 15:
            return False, f"–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç: '{answer}'"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º (–Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ)
        russian_chars = len([c for c in answer if '–∞' <= c <= '—è' or '–ê' <= c <= '–Ø' or c in '—ë–Å'])
        total_chars = len([c for c in answer if c.isalpha()])
        
        if total_chars > 10 and russian_chars / total_chars < 0.2:
            return False, f"–ú–∞–ª–æ —Ä—É—Å—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ: '{answer}'"
        
        return True, answer

    async def ask_ai(self, user_query: str, context: str = "") -> str:
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å httpx"""
        if not user_query or len(user_query.strip()) < 3:
            return "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å"

        system_prompt = self._prepare_system_prompt()

        for attempt in range(self.max_retries):
            current_model = self.get_current_model()
            
            try:
                logger.info(f"üîÑ –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1} —Å –º–æ–¥–µ–ª—å—é: {current_model}")
                
                async with httpx.AsyncClient(timeout=self.timeout) as client:
                    response = await client.post(
                        url="https://openrouter.ai/api/v1/chat/completions",
                        headers={
                            "Authorization": f"Bearer {self.api_key}",
                            "Content-Type": "application/json",
                            "HTTP-Referer": "https://t.me/HDL_Assistant_Bot",
                            "X-Title": "HDL Assistant Bot",
                        },
                        json={
                            "model": current_model,
                            "messages": [
                                {"role": "system", "content": system_prompt},
                                {"role": "user", "content": user_query}
                            ],
                            "temperature": 0.7,
                            "max_tokens": 500,
                        }
                    )

                    if response.status_code == 200:
                        data = response.json()
                        answer = data["choices"][0]["message"]["content"].strip()
                        
                        # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
                        usage = data.get('usage', {})
                        if usage:
                            logger.info(f"üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: {usage.get('total_tokens', 0)}")
                        
                        # –í–∞–ª–∏–¥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
                        is_valid, validated_answer = self._validate_ai_response(answer)
                        
                        if is_valid:
                            logger.info(f"‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç {current_model}")
                            logger.info(f"üìÑ –û—Ç–≤–µ—Ç: {validated_answer[:100]}...")
                            return validated_answer
                        else:
                            logger.warning(f"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –æ—Ç–≤–µ—Ç: {validated_answer}")
                            self.switch_to_next_model()
                    
                    elif response.status_code == 404:
                        logger.warning(f"–ú–æ–¥–µ–ª—å {current_model} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
                        self.switch_to_next_model()
                    else:
                        logger.error(f"–û—à–∏–±–∫–∞ API {response.status_code}: {response.text}")
                        if attempt == self.max_retries - 1:
                            break
                            
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –ò–ò: {e}")
                if attempt == self.max_retries - 1:
                    break
                await asyncio.sleep(1)

        return self._get_smart_fallback(user_query)

    def _get_smart_fallback(self, user_query: str) -> str:
        """–£–º–Ω—ã–π –∑–∞–ø–∞—Å–Ω–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞"""
        query_lower = user_query.lower()
        
        if any(word in query_lower for word in ['coolplug', '–∫—É–ª–ø–ª', '–∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä', 'cool plug']):
            return (
                "CoolPlug - —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–æ–≤ –≤ —Å–∏—Å—Ç–µ–º—É —É–º–Ω–æ–≥–æ –¥–æ–º–∞. "
                "–ü–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –æ–±—ã—á–Ω—ã–º–∏ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞–º–∏ —á–µ—Ä–µ–∑ Wi-Fi, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ "
                "–ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º–∏ –∏ –º–æ–∂–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ HDL, Buspro –∏ –¥—Ä—É–≥–∏–º–∏. "
                "–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –ø—Ä–µ–¥–ª–∞–≥–∞—é –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è "
                "–ø–æ–∏—Å–∫–æ–º –≤ –Ω–∞—à–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –∏–ª–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º."
            )
        
        elif any(word in query_lower for word in ['hdl', '—Ö–¥–ª']):
            return (
                "HDL - —ç—Ç–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —É–º–Ω–æ–≥–æ –¥–æ–º–∞, –≤–∫–ª—é—á–∞—é—â–∞—è —Ä–µ—à–µ–Ω–∏—è –¥–ª—è "
                "—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Å–≤–µ—â–µ–Ω–∏–µ–º, –∫–ª–∏–º–∞—Ç–æ–º, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ –º—É–ª—å—Ç–∏–º–µ–¥–∏–∞. –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç "
                "–ø—Ä–æ—Ç–æ–∫–æ–ª KNX –∏ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É "
                "–¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏."
            )
        
        elif any(word in query_lower for word in ['urri', '—É—Ä—Ä–∏']):
            return (
                "URRI - —ç—Ç–æ –±—Ä–µ–Ω–¥ –∞—É–¥–∏–æ-–≤–∏–¥–µ–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–∏—Å—Ç–µ–º —É–º–Ω–æ–≥–æ –¥–æ–º–∞, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è "
                "–Ω–∞ —Ä–µ—à–µ–Ω–∏—è—Ö –¥–ª—è –º–Ω–æ–≥–æ–∫–æ–º–Ω–∞—Ç–Ω–æ–≥–æ –∞—É–¥–∏–æ, –≤–∏–¥–µ–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∞—Å–∏—Å—Ç–µ–º–∞–º–∏. "
                "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏. "
                "–î–ª—è –ø–æ–¥–±–æ—Ä–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –ø—Ä–µ–¥–ª–∞–≥–∞—é —Å–≤—è–∑–∞—Ç—å—Å—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º."
            )

        elif any(word in query_lower for word in ['buspro', '–±–∞—Å–ø—Ä–æ', '–±—É—Å–ø—Ä–æ']):
            return (
                "Buspro - —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–º–Ω—ã–º –¥–æ–º–æ–º, –ø—Ä–µ–¥–ª–∞–≥–∞—é—â–∞—è —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ "
                "–æ—Å–≤–µ—â–µ–Ω–∏—è, –∫–ª–∏–º–∞—Ç-–∫–æ–Ω—Ç—Ä–æ–ª—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–µ–π. –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç "
                "—à–∏—Ä–æ–∫–∏–π —Å–ø–µ–∫—Ç—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ —Å–≤—è–∑–∏. –î–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ "
                "–ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É."
            )
        
        else:
            return (
                "–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –º–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å:\n\n"
                "‚Ä¢ üîç –ù–∞–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π\n"
                "‚Ä¢ üìö –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏\n" 
                "‚Ä¢ üìû –°–≤—è–∑–∞—Ç—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏."
            )

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
_ai_service = StableAIService()

async def ask_ai(user_query: str, context: str = "") -> str:
    return await _ai_service.ask_ai(user_query, context)

def get_fallback_response() -> str:
    return _ai_service._get_smart_fallback("")